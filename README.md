# Управление процессами.

## Собственная реализация (скрипт) команды `ps ax` используя анализ `/proc`

### Мануал по скрипту.

Пример вывода команды `ps ax` на апримере процесса с идентификатором `997`

```
PID  TTY  STAT   TIME   COMMAND
...
997   ?   Ss     0:00   /usr/sbin/sshd -D
```
где:

PID - идентификатор процесса;

TTY - терминал, из которого запущен процесс;

STAT - состояние процесса;

TIME - общее время процессора, затраченное на выполнение процессора;

COMMAND - команда запуска процессора.

Скрипт представляет собой набор функций, которые путем обработки файлов и подкаталогов файловой системы `/proc` собирают параметры каждого процесса, после чего осуществляется последовательный вывод.

### Вывод PID (идентификатор процесса)

Подкаталог `/proc/<PID>/` и есть `PID` самого процесса. Обходим `/proc`, выбираем подкаталоги название, которых есть цифра или число, сортируем получившийся список.

```
ls -d /proc/* | egrep "^/proc/[0-9]+" | awk 'FS="/" {print $NF}' | sort -n
```
Функция вывода PID

```
echo $PID
```

### Вывод TTY (идентификатор терминала, из которого запущен процесс)

Мануал утверждает:

```
Руководство программиста Linux PROC
...
Управляющий терминал процесса.
(minor номер устройства содержится в комбинации битов с 31 по 20 и с 7 по 0;
major номер устройства находится в битах с 15 по 8.)
...
```

Параметр `TTY` находится на 7 позиции в файле `/proc/<PID>/stat`. Но така как при выборе функцией `awk`  могут возникнуть проблемы из-за символов содержащихся во втором поле, производим выборку `46` поля с конца.

```
cat ${PID}/stat | rev | awk '{printf $46}' | rev
```
Сам алгоритм преобразования поля 

```
<PID> --> (Decimal to Binary) --> 10000000010 --> 1 0 0 0 0 0 0 0 0 1 0 --┐
                                                                         ╎
позиции бит      (31)           (20)     (15)     (8)(7)      (0)        ╎ 
                  ↓              ↓        ↓        ↓  ↓        ↓         ╎ 
0001  0000  0000  0000  0000  0000  0000  0000  0000  0001  0000         ╎ 
   1     0     0     0     0     0     0     0     0     1     0  <------┘ 
                  ╎                    ╎  └--MAJOR-┘  ╎        ╎
                  └---------┬----------┘     (15..8)  └----┬---┘
                            ╎                              ╎
                            ╎                              ╎
                            └----------------MINOR---------┘
                                         (31..20, 7..0) 
                            
MINOR 00000010 --> (Binary to Decimal) --> 2 ---┐
                                                ╎
                                                |--> ("Major" concat "Minor") --> 02 => tty2
                                                ╎
MAJOR 00 --> (Binary to Decimal) --> 0 ---------┘ 


("Major" concat "Minor") --> 02 => tty2
```

и его программную реализацию взял из интернета (нагуглил).

### Вывод STAT (состояние процесса)

Параметр `STAT` находится в `7` поле в файла `/proc/<PID>/stat`. По выше озвученной причине берем `50` поле с конца.

```
cat ${PID}/stat | rev | awk '{printf $50}' | rev
```

### Вывод TIME (общее время процессора, затраченное на выполнение процессора)

Параметр `TIME` является суммой параметров `14, 15, 16 и 17` полей файла `/proc/<PID>/stat`. Аналогично осуществляем выбор полей  `36, 37, 38 и 39` с конца.

```
cat ${PID}/stat | rev | awk '{print $36" "$37" "$38" "$39}' | rev | awk '{sum=$1+$2+$3+$4}END{print sum/100}' | awk '{("date +%M:%S -d @"$1)| getline $1}1'
```
### Вывод COMMAND (команда запуска процессора)

Параметр `COMMAND` берем из файла `/proc/<PID>/cmdline`.

```
cat ${PID}/cmdline
```

Либо, если `/proc/<PID>/cmdline` пуст, то берем имя
команды, связанное с процессом из `/proc/<PID>/comm`.

```
cat ${PID}/comm
```